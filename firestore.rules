firestore
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection rules
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId; // Ensure the document ID matches the authenticated user's UID on creation
      allow update: if request.auth != null && request.auth.uid == userId; // Allow user to update their own document
      allow delete: if false; // Prevent deletion of user documents via rules for now
    }

    // Farms collection rules
    // Farms are owned by a user, identified by the 'owner_id' field.
    match /farms/{farmId} {
      // Only authenticated users can read farms, with potential public visibility rules added later.
      // For now, allow authenticated users to read farms they own, refine later based on public/private settings.
      allow read: if request.auth != null && request.auth.uid == resource.data.owner_id; 

      // Only authenticated users with the 'farmer' role can create farms.
      // Assumes 'stakeholder_type' is stored in the user document and fetched using get()
      allow create: if request.auth != null 
                       && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.stakeholder_type == 'farmer';

      // Only the owner of the farm (identified by owner_id) can update or delete it.
      allow update: if request.auth != null && request.auth.uid == resource.data.owner_id;
      allow delete: if request.auth != null && request.auth.uid == resource.data.owner_id;
    }

    // Crops collection rules
    // Crops belong to a farm and are implicitly owned by the farm's owner.
    match /crops/{cropId} {
      // Only authenticated users can read crops, refine later based on farm's public/private settings.
 allow read: if request.auth != null && request.auth.uid == resource.data.owner_id;

      // Only authenticated users can create crops, and the crop must belong to a farm they own.
      allow create: if request.auth != null
                       && request.resource.data.owner_id == request.auth.uid; // owner_id must be set to the authenticated user's UID on creation

      // Only the owner of the farm the crop belongs to can update or delete it.
      allow update: if request.auth != null && request.auth.uid == resource.data.owner_id;
      allow delete: if request.auth != null && request.auth.uid == resource.data.owner_id;
    }

    // Shops collection rules
    // Shops are owned by a user, identified by the 'userId' field.
    match /shops/{shopId} {
      allow read: if request.auth != null; // Allow authenticated users to read any shop for now
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId; // User can create a shop linked to their UID
      allow update: if request.auth != null && request.auth.uid == resource.data.userId; // User can update their own shop
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId; // User can delete their own shop
    }

    // Collection Group rules for 'crops' to enable querying across farms owned by a user
    // Note: Collection Group rules are separate from document match rules.
    match /{path=**}/crops/{cropId} {
       allow read: if request.auth != null 
                       && request.auth.uid == resource.data.owner_id; // Allow read if the authenticated user is the owner
    }

    // Marketplace - Listings collection rules
    match /listings/{listingId} {
      // Authenticated users with the 'seller' role can create listings
      allow create: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['seller']);

      // Authenticated users can read active listings
      allow read: if request.auth != null && resource.data.status == 'active';

      // Only the seller of a listing can update or delete their own listing
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.sellerId;
    }

    // Marketplace - Offers collection rules
    match /offers/{offerId} {
      // Authenticated users with the 'buyer' role can create offers
      allow create: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['buyer']);

      // Only the buyer or the seller of the related listing can read or update an offer
      allow read, update: if request.auth != null && (request.auth.uid == resource.data.buyerId || request.auth.uid == get(/databases/$(database)/documents/listings/$(resource.data.listingId)).data.sellerId);

      // Disallow client-side deletion of offers for now (backend handled)
      allow delete: if false;
    }

    // Social Feed - Posts collection rules (assuming a top-level posts collection)
    match /posts/{postId} { 
      allow read: if request.auth != null; // Allow authenticated users to read all posts for now
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId; // Authenticated user can create post with their UID as author
      allow update: if request.auth != null && request.auth.uid == resource.data.authorId; // Only author can update
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId; // Only author can delete
    }

    // Social Feed - Comments collection rules
    match /comments/{commentId} {
      allow read: if request.auth != null; // Allow authenticated users to read all comments for now
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId; // Authenticated user can create comment with their UID as author
      allow update: if request.auth != null && request.auth.uid == resource.data.authorId; // Only author can update
      allow delete: if request.auth != null && request.auth.uid == resource.data.authorId; // Only author can delete
    }

    // Orders collection rules
    match /orders/{orderId} {
      // Orders are created by the backend, so no client-side create is allowed
      allow create: if false; 

      // Authenticated users can read an order if they are the buyer or the seller
      allow read: if request.auth != null && (request.auth.uid == resource.data.buyerId || request.auth.uid == resource.data.sellerId);
      
      // Allow updates only if authenticated and based on status and roles (simplified for now)
      // More complex role-based status transitions should be handled in backend functions
      allow update: if request.auth != null && (request.auth.uid == resource.data.buyerId || request.auth.uid == resource.data.sellerId);

      // Prevent deletion of orders via rules for now
      allow delete: if false;
    }

    // Social Feed - Likes collection rules (assuming a top-level likes collection with user_id and postId/commentId)
    match /likes/{likeId} {
      // Allow authenticated users to read, create, and delete their own likes
      // Likes implicitly belong to a post or comment, potentially link via a field
      // Refine read rules based on visibility of the liked item later
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.user_id; // Authenticated user can create like with their UID as user_id
      allow delete: if request.auth != null && request.auth.uid == resource.data.user_id; // Allow user to delete their own like
    }

    // Transactions collection rules
    // Transactions are created/updated by backend functions
    match /transactions/{transactionId} {
      // No client-side create, update, or delete allowed
      allow create, update, delete: if false;

      // Authenticated users can read a transaction if they are the buyer or the seller, or if they are an admin
      // Assumes admin role is stored in custom claims or a field in the user document
      allow read: if request.auth != null && (request.auth.token.admin == true || request.auth.uid == resource.data.buyerId || request.auth.uid == resource.data.sellerId);
    }

    // Add rules for other collections as they are defined (e.g., notifications, communication)
  }
}
      allow read: if request.auth != null && (request.auth.uid == resource.data.buyerId || request.auth.uid == resource.data.sellerId);
    }

  }
}