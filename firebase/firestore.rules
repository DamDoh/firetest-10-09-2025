
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default deny all access
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow public read access on specific collections
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth.uid == userId; // Users can update their own profile
    }
    
    match /marketplaceItems/{itemId} {
        allow read: if true;
        allow write: if request.auth != null && request.resource.data.sellerId == request.auth.uid; // Only seller can update
    }
    
    match /forums/{topicId} {
        allow read: if true;
        allow write: if request.auth != null; // Authenticated users can create/update topics
    }
    
    match /forums/{topicId}/posts/{postId} {
        allow read: if true;
        allow write: if request.auth != null;
    }

    match /agri_events/{eventId} {
      allow read: if true;
    }

    match /groups/{groupId} {
      allow read: if true;
    }
    match /groups/{groupId}/{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // Users can manage their own farms and related data
    match /farms/{farmId} {
        allow read, write: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }
    
    match /crops/{cropId} {
        allow read, write: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }

    match /knf_batches/{batchId} {
        allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    match /financial_transactions/{txId} {
      allow read, write: if request.auth != null && resource.data.userRef.id == request.auth.uid;
    }
    
    // Notifications can only be read by the recipient; writes are handled by backend
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false;
    }
    
    // Traceability events are read-only for clients
    match /vti_registry/{vtiId} {
        allow read: if true;
        allow write: if false; // Only backend
    }
    
    match /traceability_events/{eventId} {
        allow read: if true;
        allow write: if false; // Only backend
    }

    // Search index is read-only for authenticated clients
    match /search_index/{indexId} {
        allow read: if request.auth != null;
        allow write: if false; // Only backend functions can write
    }
    
    // NEW RULE FOR KNOWLEDGE BASE
    match /knowledge_base/{docId} {
      // Allow any authenticated user to read the knowledge base.
      allow read: if request.auth != null;
      // Only allow admins to write (for production).
      // For now, let's keep it open for authenticated users to allow easier populating.
      allow write: if request.auth != null; 
    }
  }
}
